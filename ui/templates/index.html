<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PV Dashboard — Israel (≤30 kW)</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.12" defer></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js" defer></script>
</head>

<body>
<a class="skip-link" href="#main">Skip to content</a>

<!-- ===== App Shell (Sidebar + Main) ===== -->
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Controls and navigation">
    <div class="brand-mini">
      <div class="brand__logo" aria-hidden="true">☀️</div>
      <div>
        <div class="brand__title">PV Dashboard — Israel</div>
        <div class="brand__subtitle">≤30 kW • Net Billing</div>
      </div>
    </div>

    <!-- Presets quick switch -->
    <section class="sb-section">
      <h2 class="sb-title">Presets</h2>
      <div class="presets presets--stack">
        <button class="preset is-active" data-preset="base">Base 20 kW • Equity</button>
        <button class="preset" data-preset="loan30">30 kW • Loan</button>
        <button class="preset" data-preset="cpi15">15 kW • CPI route</button>
      </div>
    </section>

    <!-- Inputs -->
    <section class="sb-section">
      <h2 class="sb-title">Inputs</h2>
      <form id="simForm" class="form" role="form" aria-label="PV Calculator">
        <label class="form__col">
          <span class="form__label">System size (kWp)</span>
          <input class="input" type="number" name="kWp" min="5" max="30" step="1" value="20" />
        </label>

        <label class="form__col">
          <span class="form__label">Tariff route</span>
          <select class="input" name="route">
            <option value="accelerated" selected>Accelerated</option>
            <option value="nominal">Nominal</option>
            <option value="cpi">CPI-linked</option>
          </select>
        </label>

        <label class="form__col">
          <span class="form__label">Finance mode</span>
          <select class="input" name="finance_mode">
            <option value="equity" selected>Equity</option>
            <option value="loan">Loan</option>
            <option value="leasing">Leasing</option>
          </select>
        </label>

        <label class="form__col">
          <span class="form__label">Loan scenario</span>
          <select class="input" name="loan_scenario">
            <option value="conservative">Conservative</option>
            <option value="base" selected>Base</option>
            <option value="optimistic">Optimistic</option>
          </select>
        </label>

        <label class="form__col">
          <span class="form__label">Self-consumption (0–1)</span>
          <input class="input" type="number" name="self_consumption" min="0" max="1" step="0.1" value="0.5" />
        </label>

        <div class="form__actions sticky-actions">
          <button type="submit" class="btn btn--primary" id="btnRun">Run calculation</button>
          <button type="button" class="btn" id="btnReset">Reset</button>
        </div>
      </form>
    </section>

    <!-- Help / Docs -->
    <section class="sb-section sb-help">
      <h2 class="sb-title">Docs</h2>
      <ul class="list small">
        <li>Tariff routes: Nominal / Accelerated / CPI-linked</li>
        <li>Financing: Equity, Loan (annuity), Leasing</li>
        <li>Key drivers: CAPEX, self-consumption</li>
      </ul>
    </section>
  </aside>

  <!-- Main Panel -->
  <main id="main" class="main">
    <!-- KPI Row -->
    <section class="kpi-row" aria-label="Key metrics">
      <div class="kpi">
        <div class="kpi__label">Estimated Payback</div>
        <div class="kpi__value" id="statPayback">—</div>
      </div>
      <div class="kpi">
        <div class="kpi__label">NPV (₪)</div>
        <div class="kpi__value" id="statNPV">—</div>
      </div>
      <div class="kpi">
        <div class="kpi__label">IRR</div>
        <div class="kpi__value" id="statIRR">—</div>
      </div>
      <div class="kpi kpi--muted">
        <div class="kpi__label">LCOE (pilot)</div>
        <div class="kpi__value" id="statLCOE">n/a</div>
      </div>
    </section>

    <!-- Tabs -->
    <section class="tabs card" aria-label="Views">
      <div class="tabs__list" role="tablist">
        <button class="tab is-active" role="tab" aria-selected="true" data-tab="v-presets">Presets</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="v-explain">Explanation</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="v-custom">Customize</button>
      </div>

      <!-- Presets view -->
      <div class="tabview is-active" id="v-presets" role="tabpanel">
        <div class="cards-grid">
          <div class="card soft">
            <header class="card__header"><h3>Assumptions</h3></header>
            <ul class="list small">
              <li>Yield: 1500 kWh/kWp (Year 1), degradation 0.7%/y</li>
              <li>Retail growth track: −2% / 0% / +2%</li>
              <li>Tariff routing per current PUA decisions</li>
            </ul>
          </div>
          <div class="card soft">
            <header class="card__header"><h3>Impact</h3></header>
            <ul class="list small">
              <li>Higher self-consumption → shorter payback</li>
              <li>Accelerated route ↑ early cash flow</li>
              <li>Loan shifts cash to annual annuity</li>
            </ul>
          </div>
          <div class="card soft">
            <header class="card__header"><h3>Next steps</h3></header>
            <ul class="list small">
              <li>Add loan details (rate, tenor, downpayment)</li>
              <li>Export PDF with inputs & results</li>
              <li>Save scenario to library</li>
            </ul>
          </div>
        </div>

        <div class="card">
          <header class="card__header">
            <h3>Annual Cash Flow</h3>
            <p class="muted">Nominal cash flow over 25 years (incl. OPEX and financing where selected).</p>
          </header>
          <div id="cashflowChart" class="chart" role="img" aria-label="Annual cash flow bar chart"></div>
        </div>
      </div>

      <!-- Explanation view -->
      <div class="tabview" id="v-explain" role="tabpanel" hidden>
        <div class="cards-grid">
          <div class="card soft">
            <header class="card__header"><h3>Tariff routes</h3></header>
            <ul class="list small">
              <li><b>Nominal</b>: fixed 25y (≤15 kW / 16–30 kW)</li>
              <li><b>Accelerated</b>: Y1–5 higher for first 15 kW, Y6–25 lower</li>
              <li><b>CPI-linked</b>: base rate indexed by CPI (1–3% tracks)</li>
            </ul>
          </div>
          <div class="card soft">
            <header class="card__header"><h3>Financing</h3></header>
            <ul class="list small">
              <li><b>Equity</b>: CF₀ = −CAPEX</li>
              <li><b>Loan</b>: annuity A = L·i/(1−(1+i)⁻ⁿ)</li>
              <li><b>Leasing</b>: CF₀ = 0, lease in OPEX</li>
            </ul>
          </div>
          <div class="card soft">
            <header class="card__header"><h3>KPIs</h3></header>
            <ul class="list small">
              <li><b>Payback</b>: first year cum. CF ≥ 0</li>
              <li><b>NPV</b>: Σ CFₜ/(1+r)ᵗ</li>
              <li><b>IRR</b>: r where NPV=0</li>
              <li><b>LCOE</b> (pilot): total cost / lifetime kWh</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Customize view -->
      <div class="tabview" id="v-custom" role="tabpanel" hidden>
        <div class="cards-grid">
          <div class="card soft">
            <header class="card__header"><h3>Scenario name</h3></header>
            <input class="input" type="text" placeholder="My 25 kW rooftop" />
            <button class="btn" style="margin-top:10px">Save as scenario</button>
          </div>
          <div class="card soft">
            <header class="card__header"><h3>Export</h3></header>
            <button class="btn">Export PDF</button>
          </div>
          <div class="card soft">
            <header class="card__header"><h3>Coming soon</h3></header>
            <ul class="list small">
              <li>Storage add-on</li>
              <li>Regional yield presets</li>
              <li>Taxes & VAT</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- ===== Scripts ===== -->
<script>
  // Tabs
  const tabButtons = document.querySelectorAll('.tab');
  const tabViews = document.querySelectorAll('.tabview');
  tabButtons.forEach(btn => btn.addEventListener('click', () => {
    const id = btn.dataset.tab;
    tabButtons.forEach(b => b.classList.toggle('is-active', b===btn));
    tabButtons.forEach(b => b.setAttribute('aria-selected', b===btn ? 'true' : 'false'));
    tabViews.forEach(v => {
      const active = v.id === id;
      v.classList.toggle('is-active', active);
      v.hidden = !active;
    });
  }));

  // Preset buttons (client-side param fill)
  const presetsMap = {
    base: { kWp:20, route:'accelerated', finance_mode:'equity', loan_scenario:'base', self_consumption:0.5 },
    loan30: { kWp:30, route:'accelerated', finance_mode:'loan', loan_scenario:'base', self_consumption:0.6 },
    cpi15: { kWp:15, route:'cpi', finance_mode:'equity', loan_scenario:'base', self_consumption:0.4 }
  };
  document.querySelectorAll('.preset').forEach(p => p.addEventListener('click', () => {
    document.querySelectorAll('.preset').forEach(x => x.classList.remove('is-active'));
    p.classList.add('is-active');
    const f = document.getElementById('simForm');
    const s = presetsMap[p.dataset.preset];
    if (s){ Object.entries(s).forEach(([k,v]) => { if (f.elements[k]) f.elements[k].value = v; }); }
  }));

  // Serialize form
  function paramsFromForm(form) {
    const fd = new FormData(form);
    return new URLSearchParams([...fd.entries()]).toString();
  }

  // Update metric cards
  function updateMetrics(metrics) {
    const pay = metrics.payback_year ?? '—';
    const npv = metrics.npv != null ? Math.round(metrics.npv).toLocaleString('he-IL') : '—';
    const irr = metrics.irr != null ? (metrics.irr * 100).toFixed(1) + '%' : 'n/a';
    const lcoe = metrics.lcoe != null ? '₪ ' + metrics.lcoe.toFixed(2) + '/kWh' : 'n/a';

    const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
    set('statPayback', typeof pay === 'number' ? pay + 'y' : '—');
    set('statNPV', '₪ ' + npv);
    set('statIRR', irr);
    set('statLCOE', lcoe);
  }

  // Plot cashflow
  function drawCashflow(years, cashflow) {
    const el = document.getElementById('cashflowChart');
    if (!window.Plotly || !el) return;
    const data = [{ x: years, y: cashflow, type: 'bar', hovertemplate: 'Year %{x}<br>₪%{y:,.0f}<extra></extra>' }];
    const layout = {
      margin: { t: 24, r: 16, b: 40, l: 56 },
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent',
      yaxis: { tickprefix: '₪', gridcolor: '#2a2f3b' },
      xaxis: { gridcolor: '#2a2f3b' }
    };
    const config = { displayModeBar: false, responsive: true };
    Plotly.react(el, data, layout, config);
  }

  // Submit → API
  document.getElementById('simForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.currentTarget;
    const btn = document.getElementById('btnRun');
    btn.disabled = true; btn.textContent = 'Calculating...';

    try {
      const qs = paramsFromForm(form);
      const res = await fetch(`/api/sim?${qs}`);
      if (!res.ok) throw new Error('Request failed: ' + res.status);
      const data = await res.json();

      updateMetrics(data.metrics || {});
      drawCashflow(data.years || [], data.cashflow || []);
    } catch (err) {
      console.error(err);
      updateMetrics({ payback_year: '—', npv: null, irr: null, lcoe: null });
      drawCashflow([], []);
      alert('Calculation failed. Please try again.');
    } finally {
      btn.disabled = false; btn.textContent = 'Run calculation';
    }
  });

  // Reset
  document.getElementById('btnReset')?.addEventListener('click', () => {
    document.getElementById('simForm').reset();
    ['statPayback','statNPV','statIRR','statLCOE'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = '—'; });
    const ch = document.getElementById('cashflowChart');
    if (ch && window.Plotly) Plotly.purge(ch);
  });
</script>
</body>
</html>
