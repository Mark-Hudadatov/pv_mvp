<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PV Dashboard ‚Äî Israel (‚â§30 kW)</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Plotly –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js" defer></script>
</head>
<body>
<div class="app">

  <!-- ===== Sidebar ===== -->
  <aside class="sidebar" aria-label="Primary">
    <div class="brand">
      <div class="brand__logo" aria-hidden="true">‚òÄÔ∏è</div>
      <div class="brand__text">
        <div class="brand__title">PV Dashboard</div>
        <div class="brand__subtitle">Israel ‚Ä¢ ‚â§30 kW</div>
      </div>
    </div>

    <nav class="nav" aria-label="Main">
      <a class="nav__item is-active" href="#" aria-current="page">
        <span class="nav__icon" aria-hidden="true">üìä</span> Calculator
      </a>
      <a class="nav__item" href="#"><span class="nav__icon" aria-hidden="true">üìÅ</span> Scenarios</a>
      <a class="nav__item" href="#"><span class="nav__icon" aria-hidden="true">üìÑ</span> Reports</a>
      <a class="nav__item" href="#"><span class="nav__icon" aria-hidden="true">üìö</span> Docs</a>
    </nav>
  </aside>

  <!-- ===== Main ===== -->
  <main class="main">

    <!-- Topbar -->
    <header class="topbar">
      <form class="search" role="search" aria-label="Search">
        <input class="search__input" type="search" placeholder="Search" />
      </form>
      <div class="topbar__right">
        <button class="chip" type="button">English ‚ñæ</button>
        <button class="chip" type="button" title="Notifications">üîî</button>
        <div class="avatar" title="User"></div>
      </div>
    </header>

    <!-- KPI Row -->
    <section class="kpi-row" aria-label="Key Indicators">
      <article class="kpi" role="status" aria-live="polite">
        <div class="kpi__icon" aria-hidden="true">‚è±Ô∏è</div>
        <div class="kpi__label">Estimated Payback</div>
        <div class="kpi__value" id="kpi-payback">‚Äî</div>
      </article>
      <article class="kpi" role="status" aria-live="polite">
        <div class="kpi__icon" aria-hidden="true">‚Ç™</div>
        <div class="kpi__label">NPV</div>
        <div class="kpi__value" id="kpi-npv">‚Äî</div>
      </article>
      <article class="kpi" role="status" aria-live="polite">
        <div class="kpi__icon" aria-hidden="true">üìà</div>
        <div class="kpi__label">IRR</div>
        <div class="kpi__value" id="kpi-irr">‚Äî</div>
      </article>
      <article class="kpi kpi--muted">
        <div class="kpi__icon" aria-hidden="true">‚öôÔ∏è</div>
        <div class="kpi__label">LCOE (pilot)</div>
        <div class="kpi__value" id="kpi-lcoe">‚Äî</div>
      </article>
    </section>

    <!-- Main grid -->
    <section class="grid" aria-label="Dashboard content">

      <!-- Large card: Annual Cash Flow -->
      <section class="card card--lg" aria-labelledby="acf-title">
        <header class="card__header">
          <h2 id="acf-title">Annual Cash Flow</h2>
          <div class="toolbar" aria-label="View switches">
            <button class="tab is-active" type="button" data-view="annual">Annual</button>
            <button class="tab" type="button" data-view="cumulative">Cumulative</button>
            <button class="tab" type="button" data-view="sensitivity">Sensitivity</button>
          </div>
        </header>
        <div class="chart" id="chart-cashflow" aria-label="Cash flow chart"></div>
      </section>

      <!-- Right stack: info/help widgets -->
      <aside class="stack" aria-label="Info widgets">
        <section class="card" aria-labelledby="who-title">
          <header class="card__header"><h3 id="who-title">Who is this for?</h3></header>
          <ul class="list small">
            <li><b>SMBs & municipalities</b> ‚Äî quick payback check for small rooftops</li>
            <li><b>Condo roofs (‚â§30 kW)</b> ‚Äî transparent options incl. leasing</li>
            <li><b>Investors</b> ‚Äî standardized view (IRR / NPV / LCOE)</li>
          </ul>
        </section>

        <section class="card" aria-labelledby="checklist-title">
          <header class="card__header"><h3 id="checklist-title">Checklist</h3></header>
          <ul class="list small" id="list-checks">
            <li>CAPEX ‚â§ ‚Ç™4,000/kWp ‚Üí IRR typically &gt; 7%</li>
            <li>Route matches PUA decision (Nominal / Accelerated / CPI)</li>
            <li>Self-consumption track applied consistently</li>
          </ul>
        </section>
      </aside>

      <!-- Bottom left: Presets -->
      <section class="card" aria-labelledby="presets-title">
        <header class="card__header"><h3 id="presets-title">Presets</h3></header>
        <div class="presets" role="listbox" aria-label="Scenario presets" id="presets-list">
          <button class="preset is-active" role="option" aria-selected="true" data-preset="equity20">
            20 kW ‚Ä¢ Equity ‚Ä¢ Accelerated
          </button>
          <button class="preset" role="option" aria-selected="false" data-preset="loan30">
            30 kW ‚Ä¢ Loan ‚Ä¢ Accelerated
          </button>
          <button class="preset" role="option" aria-selected="false" data-preset="cpi15">
            15 kW ‚Ä¢ Equity ‚Ä¢ CPI-linked
          </button>
        </div>
        <p class="muted small">Presets auto-fill inputs and re-run the calculation.</p>
      </section>

      <!-- Bottom right: Customize -->
      <section class="card" aria-labelledby="custom-title">
        <header class="card__header"><h3 id="custom-title">Customize</h3></header>
        <form id="form-sim" class="form" aria-label="PV Calculator">
          <div class="form__row">
            <label class="form__col icon--kwp">
              <span class="form__label">System size (kWp)</span>
              <input class="input" type="number" name="kWp" min="5" max="30" step="1" value="20" />
            </label>

            <label class="form__col icon--route">
              <span class="form__label">Tariff route</span>
              <select class="input" name="route" id="inp-route">
                <option value="accelerated" selected>Accelerated</option>
                <option value="nominal">Nominal</option>
                <option value="cpi">CPI-linked</option>
              </select>
            </label>

            <label class="form__col icon--fin">
              <span class="form__label">Finance mode</span>
              <select class="input" name="finance_mode" id="inp-finance">
                <option value="equity" selected>Equity</option>
                <option value="loan">Loan</option>
                <option value="leasing">Leasing</option>
              </select>
            </label>

            <label class="form__col icon--loan">
              <span class="form__label">Loan scenario</span>
              <select class="input" name="loan_scenario" id="inp-loan">
                <option value="conservative">Conservative</option>
                <option value="base" selected>Base</option>
                <option value="optimistic">Optimistic</option>
              </select>
            </label>

            <label class="form__col icon--self">
              <span class="form__label">Self-consumption (0‚Äì1)</span>
              <input class="input" type="number" name="self_consumption" min="0" max="1" step="0.1" value="0.5" />
            </label>
          </div>

          <div class="form__actions">
            <button class="btn btn--primary" type="submit" id="btn-run">Run calculation</button>
            <button class="btn" type="reset" id="btn-reset">Reset</button>
          </div>
        </form>
      </section>

    </section>
  </main>
</div>

<!-- ===== Minimal JS: tabs, presets, /api/sim ===== -->
<script>
(function(){
  // Helper: set text
  const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

  // Tabs (Annual / Cumulative / Sensitivity)
  const tabButtons = document.querySelectorAll('.tab');
  let currentView = 'annual';
  tabButtons.forEach(btn => btn.addEventListener('click', () => {
    tabButtons.forEach(b => b.classList.toggle('is-active', b===btn));
    currentView = btn.dataset.view;
    // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏
    if (window.__simData) renderChart(window.__simData);
  }));

  // Presets autofill
  const presets = {
    equity20: { kWp:20, route:'accelerated', finance_mode:'equity',  loan_scenario:'base', self_consumption:0.5 },
    loan30:   { kWp:30, route:'accelerated', finance_mode:'loan',    loan_scenario:'base', self_consumption:0.6 },
    cpi15:    { kWp:15, route:'cpi',         finance_mode:'equity',  loan_scenario:'base', self_consumption:0.4 }
  };
  const form = document.getElementById('form-sim');
  document.querySelectorAll('#presets-list .preset').forEach(btn => {
    btn.addEventListener('click', async () => {
      document.querySelectorAll('#presets-list .preset').forEach(x=>{
        x.classList.remove('is-active'); x.setAttribute('aria-selected','false');
      });
      btn.classList.add('is-active'); btn.setAttribute('aria-selected','true');
      const p = presets[btn.dataset.preset]; if (!p) return;
      // –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
      for (const [k,v] of Object.entries(p)) { if (form.elements[k]) form.elements[k].value = v; }
      // –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Ä–∞—Å—Å—á—ë—Ç–∞
      await runSim();
    });
  });

  // Serialize form
  function formParams(f){
    const fd = new FormData(f);
    return new URLSearchParams([...fd.entries()]).toString();
  }

  // Render KPI values
  function renderKPIs(m){
    setText('kpi-payback', (typeof m?.payback_year === 'number') ? (m.payback_year + 'y') : '‚Äî');
    setText('kpi-npv',     (typeof m?.npv === 'number') ? ('‚Ç™ ' + Math.round(m.npv).toLocaleString('he-IL')) : '‚Äî');
    setText('kpi-irr',     (typeof m?.irr === 'number') ? ((m.irr*100).toFixed(1) + '%') : '‚Äî');
    setText('kpi-lcoe',    (typeof m?.lcoe === 'number') ? ('‚Ç™ ' + m.lcoe.toFixed(2) + '/kWh') : '‚Äî');
  }

  // Render Chart (Annual / Cumulative / Sensitivity)
  function renderChart(data){
    const el = document.getElementById('chart-cashflow');
    if (!el || !window.Plotly) return;

    let x = data.years || [];
    let y = [];

    if (currentView === 'annual') {
      y = data.cashflow || [];
    } else if (currentView === 'cumulative') {
      const arr = data.cashflow || [];
      let cum = 0; y = arr.map(v => (cum += (v||0)));
    } else if (currentView === 'sensitivity') {
      // –ø—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º baseline +/-10% (–µ—Å–ª–∏ –Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞)
      const arr = data.cashflow || [];
      const base = arr.map(v => v||0);
      const up = base.map(v => v*1.1);
      const dn = base.map(v => v*0.9);
      Plotly.react(el, [
        { x, y: dn,  type:'scatter', mode:'lines', name:'-10%' },
        { x, y: base,type:'scatter', mode:'lines', name:'Base' },
        { x, y: up,  type:'scatter', mode:'lines', name:'+10%' }
      ], {
        margin:{t:24,r:16,b:40,l:56},
        paper_bgcolor:'transparent', plot_bgcolor:'transparent',
        yaxis:{ tickprefix:'‚Ç™', gridcolor:'#e7ebf2' }, xaxis:{ gridcolor:'#e7ebf2' }
      }, {displayModeBar:false, responsive:true});
      return;
    }

    // default: –∫–æ–ª–æ–Ω–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
    Plotly.react(el, [{
      x, y, type:'bar', hovertemplate:'Year %{x}<br>‚Ç™%{y:,.0f}<extra></extra>'
    }], {
      margin:{t:24,r:16,b:40,l:56},
      paper_bgcolor:'transparent', plot_bgcolor:'transparent',
      yaxis:{ tickprefix:'‚Ç™', gridcolor:'#e7ebf2' }, xaxis:{ gridcolor:'#e7ebf2' }
    }, {displayModeBar:false, responsive:true});
  }

  // Call /api/sim
  async function runSim(){
    const btn = document.getElementById('btn-run');
    btn.disabled = true; const old = btn.textContent; btn.textContent = 'Calculating‚Ä¶';
    try{
      const qs = formParams(form);
      const res = await fetch(`/api/sim?${qs}`);
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      // –æ–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: { metrics:{payback_year,npv,irr,lcoe}, years:[], cashflow:[] }
      window.__simData = data || {};
      renderKPIs(data.metrics || {});
      renderChart(data || {});
    }catch(err){
      console.error(err);
      renderKPIs({});
      renderChart({ years:[], cashflow:[] });
      alert('Calculation failed. Please try again.');
    }finally{
      btn.disabled = false; btn.textContent = old;
    }
  }

  // Form submit
  form?.addEventListener('submit', (e)=>{ e.preventDefault(); runSim(); });
  document.getElementById('btn-reset')?.addEventListener('click', ()=>{
    renderKPIs({}); renderChart({ years:[], cashflow:[] });
  });

  // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  window.addEventListener('load', ()=>{
    const active = document.querySelector('#presets-list .preset.is-active');
    active?.click();
  });
})();
</script>
</body>
</html>
