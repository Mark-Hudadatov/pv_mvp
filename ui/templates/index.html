<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Israeli Rooftop PV â€” Calculator For SMB & Municipalities (â‰¤30 kW)</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
  <!-- ===== Header / Brand ===== -->
  <header class="site-header">
    <div class="container header__wrap">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true">â˜€ï¸</div>
        <div>
          <div class="brand__title">PV Dashboard for SMB in Israel</div>
          <div class="brand__subtitle">Transparent payback for small rooftops (â‰¤30 kW)</div>
        </div>
      </div>
    </div>
  </header>

  <main id="main" class="main container">

    <!-- ===== Calculator FIRST BLOCK ===== -->
    <section id="calculator" class="card card--grid">
      <header class="card__header">
        <h2>Calculator â€” Start Here</h2>
        <p class="muted">
          âš–ï¸ Based on <a href="https://www.gov.il/he/departments/pua" target="_blank">PUA</a> & 
          <a href="https://www.energy.gov.il" target="_blank">××©×¨×“ ×”×× ×¨×’×™×”</a>.<br>
          ğŸ¯ Focus: SMB & municipalities (typical rooftops 100â€“300 mÂ²).<br>
          ğŸ’¡ Presets explain common cases: Conservative, Base, Optimistic.
        </p>
      </header>

      <!-- Form -->
      <form id="simForm" class="form" role="form" aria-label="PV Calculator">
        <div class="form__row">
          <label class="form__col">
            <span class="form__label">System size (kWp)</span>
            <input class="input" type="number" name="kwp" min="5" max="30" step="1" value="20" />
          </label>

          <label class="form__col">
            <span class="form__label">Tariff route</span>
            <select class="input" name="route">
              <option value="accelerated" selected>Accelerated</option>
              <option value="nominal">Nominal</option>
              <option value="cpi">CPI-linked</option>
            </select>
          </label>

          <label class="form__col">
            <span class="form__label">Finance mode</span>
            <select class="input" name="finance_mode">
              <option value="equity" selected>Equity</option>
              <option value="loan">Loan</option>
              <option value="leasing">Leasing</option>
            </select>
          </label>

          <label class="form__col">
            <span class="form__label">Loan scenario</span>
            <select class="input" name="loan_scenario">
              <option value="conservative">Conservative</option>
              <option value="base" selected>Base</option>
              <option value="optimistic">Optimistic</option>
            </select>
          </label>

          <label class="form__col">
            <span class="form__label">Self-consumption (0â€“1)</span>
            <input class="input" type="number" name="self_consumption" min="0" max="1" step="0.1" value="0.5" />
          </label>
        </div>

        <div class="form__actions">
          <button type="submit" class="btn btn--primary" id="btnRun">Run calculation</button>
          <button type="button" class="btn" id="btnReset">Reset</button>
        </div>
      </form>

      <!-- Preset Scenarios -->
      <div class="presets">
        <h3>Preset Scenarios</h3>
        <div class="preset-grid">
          <button class="preset" data-scenario="conservative">Conservative<br><small>High CAPEX, low self-consumption</small></button>
          <button class="preset is-active" data-scenario="base">Base<br><small>Typical SMB rooftop</small></button>
          <button class="preset" data-scenario="optimistic">Optimistic<br><small>Low CAPEX, high self-consumption</small></button>
        </div>
      </div>

      <!-- Results -->
      <div class="results">
        <div class="results__metrics">
          <div class="metric"><div class="metric__label">Payback (yrs)</div><div class="metric__value" id="mPayback">â€”</div></div>
          <div class="metric"><div class="metric__label">NPV (â‚ª)</div><div class="metric__value" id="mNPV">â€”</div></div>
          <div class="metric"><div class="metric__label">IRR</div><div class="metric__value" id="mIRR">â€”</div></div>
        </div>

        <div class="chart-toggle">
          <button type="button" class="toggle-btn active" data-mode="annual">Annual</button>
          <button type="button" class="toggle-btn" data-mode="cumulative">Cumulative</button>
        </div>
        <div id="cashflowChart" class="chart"></div>
      </div>
    </section>

    <!-- ===== Hero ===== -->
    <section class="hero">
      <div class="container hero__wrap">
        <div class="hero__copy">
          <h1 class="hero__title">Is PV worth it for your roof?</h1>
          <p class="hero__text">
            This calculator gives a transparent estimate for small-voltage rooftop PV in Israel. 
            Perfect for SMB rooftops and condo roofs up to 30 kW.
          </p>
        </div>
      </div>
    </section>

    <!-- ===== FAQ ===== -->
    <section id="faq" class="card">
      <header class="card__header"><h2>FAQ</h2></header>
      <div class="faq">
        <details><summary>What roof size do I need for 30 kW?</summary>
          <p>Rule of thumb: ~0.14 kW/mÂ². A 30 kW system needs ~210â€“230 mÂ² usable area.</p>
        </details>
        <details><summary>Does self-consumption matter?</summary>
          <p>Yes, each kWh offsets retail tariff and improves payback.</p>
        </details>
        <details><summary>Can I switch tariff routes after installation?</summary>
          <p>No. Route chosen at application is binding.</p>
        </details>
      </div>
    </section>

    <!-- ===== About ===== -->
    <section id="about" class="card">
      <header class="card__header"><h2>About this MVP</h2></header>
      <p>This MVP was built by 
        <a href="https://www.linkedin.com/in/markhudadatov" target="_blank">Mark Khudadatov</a>.
      </p>
      <p>Version v0.1.0 â€” Aug 2025. 
        Source on <a href="https://github.com/YOUR-USERNAME/pv_mvp" target="_blank">GitHub</a>.
      </p>
    </section>

  </main>

  <!-- ===== Scripts ===== -->
  <script>
    let lastData = { years: [], cashflow: [] };

    function updateMetrics(metrics) {
      document.getElementById("mPayback").textContent = metrics.payback_year ?? "â€”";
      document.getElementById("mNPV").textContent = metrics.npv != null ? "â‚ª " + Math.round(metrics.npv).toLocaleString("he-IL") : "â€”";
      document.getElementById("mIRR").textContent = metrics.irr != null ? (metrics.irr*100).toFixed(1)+"%" : "â€”";
    }

    function drawCashflow(years, cashflow, mode="annual") {
      lastData = { years, cashflow };
      const el = document.getElementById("cashflowChart");
      if (!window.Plotly || !el) return;
      const y = mode==="cumulative"
        ? cashflow.map((v,i)=> v + (i>0?cashflow.slice(0,i).reduce((a,b)=>a+b,0):0))
        : cashflow;
      const data = [{ x: years.map((_,i)=>2026+i), y, type:"bar" }];
      Plotly.newPlot(el, data, {margin:{t:20}, xaxis:{title:"Year"}, yaxis:{title:"â‚ª"}},{displayModeBar:false});
    }

    document.getElementById("simForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const qs = new URLSearchParams(new FormData(e.target)).toString();
      const res = await fetch(`/api/sim?${qs}`);
      const data = await res.json();
      if (data.status!=="ok") return alert("Error: "+(data.message||"failed"));
      updateMetrics(data.metrics||{});
      drawCashflow(data.years||[], data.cashflow||[]);
    });

    document.getElementById("btnReset")?.addEventListener("click", ()=>{
      document.getElementById("simForm").reset();
      updateMetrics({});
      drawCashflow([], []);
    });

    document.querySelectorAll(".preset").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".preset").forEach(b=>b.classList.remove("is-active"));
        btn.classList.add("is-active");
        document.querySelector("select[name=loan_scenario]").value = btn.dataset.scenario;
      });
    });

    document.querySelectorAll(".chart-toggle button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".chart-toggle button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        drawCashflow(lastData.years, lastData.cashflow, btn.dataset.mode);
      });
    });
  </script>
</body>
</html>
